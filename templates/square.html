{% extends "base.html" %}
{% block title %}交流广场 - 宝黄天{% endblock %}

{% block content %}
<style>
/* 隐藏回复项的样式 */
.reply-item.reply-hidden {
    display: none !important;
}

/* 自定义滚动条样式 */
.card-body::-webkit-scrollbar {
    width: 8px;
}

.card-body::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.card-body::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 4px;
}

.card-body::-webkit-scrollbar-thumb:hover {
    background: #555;
}

/* 消息卡片样式优化 */
#post-\d+ {
    transition: all 0.3s ease;
}

/* 自己的消息样式 */
.d-flex.justify-content-end {
    .bg-warning.bg-opacity-25 {
        background-color: #ffe0b2 !important;
        border: 1px solid #ffcc80;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
}

/* 他人的消息样式 */
.d-flex.justify-content-start {
    .bg-light {
        background-color: #ffffff !important;
        border: 1px solid #ffe0b2;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
}

/* 消息内容区域 */
.bg-warning.bg-opacity-25,
.bg-light {
    border-radius: 12px !important;
    transition: all 0.3s ease;
}

.bg-warning.bg-opacity-25:hover,
.bg-light:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* 头像样式优化 */
.clickable-avatar {
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.clickable-avatar:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

/* 用户名样式 */
.clickable-username {
    font-weight: 600;
    color: #333;
    transition: all 0.2s ease;
}

.clickable-username:hover {
    color: #0d6efd;
    text-decoration: underline;
}

/* 按钮样式优化 */
.btn {
    transition: all 0.3s ease;
    border-radius: 8px;
}

.btn-sm {
    padding: 0.25rem 0.75rem;
    font-size: 0.875rem;
}

/* 点赞按钮优化 */
.btn-like {
    background-color: #fff;
    color: #6c757d;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.btn-like:hover {
    background-color: #f8f9fa;
    color: #dc3545;
    border-color: #dc3545;
    transform: translateY(-1px);
}

.btn-like:active {
    transform: translateY(0);
}

.btn-like.liked {
    background-color: #fff;
    color: #dc3545;
    border-color: #dc3545;
}

.btn-like.liked:hover {
    background-color: #dc3545;
    color: #fff;
}

/* 其他按钮优化 */
.btn-outline-secondary {
    border-color: #dee2e6;
    color: #6c757d;
}

.btn-outline-secondary:hover {
    background-color: #f8f9fa;
    border-color: #adb5bd;
    transform: translateY(-1px);
}

.btn-outline-danger {
    border-color: #ffcdd2;
    color: #dc3545;
}

.btn-outline-danger:hover {
    background-color: #dc3545;
    color: #fff;
    transform: translateY(-1px);
}

/* 输入区域样式 */
.form-control {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
}

.form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.1);
    transform: translateY(-1px);
}

.form-control-sm {
    border-radius: 6px;
}

/* 输入框占位符样式 */
.form-control::placeholder {
    color: #adb5bd;
}

/* 图片上传区域样式 */
.input-group-text {
    border-radius: 6px 0 0 6px;
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

/* 发布按钮样式 */
.btn-primary {
    background-color: #0d6efd;
    border-color: #0d6efd;
    border-radius: 8px;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    background-color: #0b5ed7;
    border-color: #0a58ca;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(13, 110, 253, 0.3);
}

.btn-primary:active {
    transform: translateY(0);
}

/* 搜索表单样式 */
.form-select.form-select-sm {
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

/* 卡片样式优化 */
.card {
    border-radius: 16px !important;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12) !important;
    transition: all 0.3s ease;
}

.card:hover {
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.16) !important;
}

/* 卡片头部样式 */
.card-header {
    border-radius: 16px 16px 0 0 !important;
    background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%) !important;
    border: none !important;
}

/* 卡片底部样式 */
.card-footer {
    border-radius: 0 0 16px 16px !important;
    background-color: #fafafa !important;
    border-top: 1px solid #e9ecef !important;
}

/* 时间显示样式 */
.text-muted {
    color: #6c757d !important;
    font-size: 0.75rem;
}

/* 图片样式优化 */
.img-fluid.rounded {
    border-radius: 8px !important;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
}

.img-fluid.rounded:hover {
    transform: scale(1.02);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
}

/* 回复项样式 */
.reply-item {
    transition: all 0.3s ease;
}

.reply-item:hover {
    transform: translateX(4px);
}

/* 展开/收起按钮样式 */
.btn-link.text-muted {
    color: #0d6efd !important;
    font-weight: 500;
    transition: all 0.2s ease;
}

.btn-link.text-muted:hover {
    text-decoration: underline !important;
    color: #0a58ca !important;
}

/* 引用信息样式 */
.bg-light.p-2.rounded.border.border-primary {
    background-color: #e3f2fd !important;
    border-color: #bbdefb !important;
    border-radius: 8px !important;
}

/* 用户名和头像的交互效果 */
.clickable-avatar,
.clickable-username {
    cursor: pointer;
    transition: all 0.2s ease;
}

.clickable-avatar:hover,
.clickable-username:hover {
    opacity: 0.8;
}

/* 消息间距调整 */
.mb-4 {
    margin-bottom: 1.5rem !important;
}

.mb-1 {
    margin-bottom: 0.5rem !important;
}

/* 主容器样式 */
.container.mt-5 {
    margin-top: 2rem !important;
}

/* 搜索区域样式 */
.form-select.form-select-sm.me-2,
.form-control.form-control-sm.me-2 {
    border-radius: 6px;
    border: 1px solid #dee2e6;
}

/* 优化按钮组间距 */
.d-flex.justify-content-start.mt-1,
.d-flex.justify-content-end.mt-1 {
    gap: 0.5rem;
}

/* 消息内容文本样式 */
.card-body p {
    margin-bottom: 0.5rem !important;
    line-height: 1.5;
}

/* 商品信息卡片样式 */
.ms-2.me-2.p-2.rounded {
    border-radius: 8px !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.ms-2.me-2.p-2.rounded:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}
</style>

<script>
// 显示Alert通知
function showAlert(message, duration = 3000) {
    // 检查是否已有alert元素
    let alertElement = document.querySelector('.alert');
    if (!alertElement) {
        // 创建alert元素
        alertElement = document.createElement('div');
        alertElement.className = 'alert alert-success';
        alertElement.style.position = 'fixed';
        alertElement.style.top = '20px';
        alertElement.style.right = '20px';
        alertElement.style.zIndex = '1030';
        alertElement.style.minWidth = '300px';
        alertElement.style.opacity = '1';
        alertElement.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
        alertElement.style.transform = 'translateX(0)';
        alertElement.style.textAlign = 'center';
        document.body.appendChild(alertElement);
    }
    
    // 设置Alert内容
    alertElement.textContent = message;
    
    // 显示Alert
    alertElement.style.display = 'block';
    
    // 移除可能存在的fade-out类，确保Alert完全可见
    alertElement.classList.remove('fade-out');
    
    // 3秒后开始淡出
    setTimeout(() => {
        alertElement.classList.add('fade-out');
        // 淡出动画结束后隐藏元素
        setTimeout(() => {
            alertElement.style.display = 'none';
            alertElement.classList.remove('fade-out');
        }, 500);
    }, duration);
}

// 保存滚动位置到localStorage
function saveScrollPosition() {
    // 使用更精确的选择器
    const chatContainer = document.querySelector('.card-body[style*="overflow-y: auto"]');
    if (chatContainer) {
        const scrollPosition = chatContainer.scrollTop;
        localStorage.setItem('chatScrollTop', scrollPosition);
        console.log('滚动位置已保存:', scrollPosition);
    } else {
        console.error('未找到聊天容器元素');
    }
}

// 恢复滚动位置
function restoreScrollPosition() {
    // 使用更精确的选择器获取聊天容器
    const chatContainer = document.querySelector('.card-body[style*="overflow-y: auto"]');
    if (chatContainer) {
        // 检查URL是否有post_id参数，如果有则不自动滚动到底部（由scrollToPost处理）
        const urlParams = new URLSearchParams(window.location.search);
        const postId = urlParams.get('post_id');
        
        if (!postId) {
            // 没有post_id参数，进入广场页面自动滚动到底部
            console.log('进入广场页面，自动滚动聊天容器到底部');
            
            // 使用setTimeout确保所有内容都已加载完成
            setTimeout(function() {
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 100);
        } else {
            console.log('URL中有post_id参数，将由scrollToPost处理滚动定位');
        }
    } else {
        console.error('未找到聊天容器元素');
    }
}

// 切换回复的展开/收起状态
function toggleReplies(postId, totalReplies) {
    const container = document.getElementById(`replies-container-${postId}`);
    const toggleBtn = document.getElementById(`toggle-btn-${postId}`);
    const allReplies = container.querySelectorAll('.reply-item');
    
    // 检查当前状态
    const isExpanded = toggleBtn.textContent.includes('收起');
    
    if (isExpanded) {
        // 收起回复：给除了第一条回复外的所有回复项添加reply-hidden类
        allReplies.forEach((reply, index) => {
            if (index > 0) {
                reply.classList.add('reply-hidden');
            }
        });
        toggleBtn.textContent = `展开更多回复 (${totalReplies - 1})`;
    } else {
        // 展开回复：移除所有回复项的reply-hidden类
        allReplies.forEach(reply => {
            reply.classList.remove('reply-hidden');
        });
        toggleBtn.textContent = `收起`;
    }
}

// 定位到指定帖子
function scrollToPost(postId) {
    const postElement = document.getElementById(`post-${postId}`);
    const chatContainer = document.querySelector('.card-body[style*="overflow-y: auto"]');
    if (postElement && chatContainer) {
        // 计算帖子在聊天容器内的相对位置
        const postOffsetTop = postElement.offsetTop;
        const containerScrollTop = chatContainer.scrollTop;
        const scrollPosition = postOffsetTop - 50;
        
        // 只在聊天容器内滚动
        chatContainer.scrollTo({
            top: scrollPosition,
            behavior: 'smooth'
        });
        
        // 高亮显示帖子
        postElement.style.backgroundColor = '#fff3cd';
        setTimeout(() => {
            postElement.style.backgroundColor = '';
        }, 2000);
    }
}

// 显示用户信息
function showUserInfo(userId) {
    // 可以实现为弹出模态框或跳转到用户主页
    window.location.href = `/user/${userId}/profile`;
}

// 切换回复表单显示状态
function toggleReplyForm(postId, quotedId, quotedType, username) {
    const replyForm = document.getElementById(`reply-form-${postId}`);
    const quotedPostIdInput = document.getElementById(`quoted-post-id-${postId}`);
    const quoteInfo = document.getElementById(`quote-info-${postId}`);
    
    if (replyForm) {
        // 切换回复表单的显示状态
        replyForm.classList.toggle('d-none');
        
        // 设置引用信息
        if (quotedId && quotedType) {
            quotedPostIdInput.value = quotedId;
            if (quoteInfo) {
                quoteInfo.classList.remove('d-none');
                quoteInfo.querySelector('p').innerHTML = `<strong>回复:</strong> @${username}`;
            }
        } else {
            quotedPostIdInput.value = '';
            if (quoteInfo) {
                quoteInfo.classList.add('d-none');
            }
        }
    }
}

// @用户功能
function mentionUser(username) {
    // 获取主表单的内容字段
    const contentField = document.querySelector('#content');
    if (contentField) {
        // 在光标位置插入@用户名
        const startPos = contentField.selectionStart;
        const endPos = contentField.selectionEnd;
        const textBefore = contentField.value.substring(0, startPos);
        const textAfter = contentField.value.substring(endPos);
        contentField.value = textBefore + `@${username} ` + textAfter;
        
        // 聚焦并设置光标位置
        contentField.focus();
        contentField.selectionStart = contentField.selectionEnd = startPos + username.length + 2;
    }
}

// 处理点赞操作
function handleLikePost(postId, isLiked) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // 显示加载状态
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';
    button.disabled = true;
    
    // 构造URL
    const url = `/post/${postId}/like`;
    
    // 发送POST请求
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(() => {
        // 更新点赞状态和数量
        const likeCount = parseInt(button.textContent.match(/\d+/)[0]);
        if (isLiked) {
            // 取消点赞
            button.innerHTML = `<i class="fa fa-heart-o"></i> ${likeCount - 1}`;
            button.classList.remove('liked');
            showAlert('已取消点赞');
        } else {
            // 点赞
            button.innerHTML = `<i class="fa fa-heart"></i> ${likeCount + 1}`;
            button.classList.add('liked');
            showAlert('点赞成功');
        }
    })
    .catch(error => {
        console.error('点赞失败：', error);
        button.innerHTML = originalContent;
        showAlert('操作失败，请稍后重试', 4000);
    })
    .finally(() => {
        button.disabled = false;
    });
}

// 处理回复点赞操作
function handleLikeReply(replyId, isLiked) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // 显示加载状态
    button.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 处理中...';
    button.disabled = true;
    
    // 构造URL
    const url = `/reply/${replyId}/like`;
    
    // 发送POST请求
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token() }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        }
    })
    .then(() => {
        // 更新点赞状态和数量
        const likeCount = parseInt(button.textContent.match(/\d+/)[0]);
        if (isLiked) {
            // 取消点赞
            button.innerHTML = `<i class="fa fa-heart-o"></i> ${likeCount - 1}`;
            button.classList.remove('liked');
            showAlert('已取消点赞');
        } else {
            // 点赞
            button.innerHTML = `<i class="fa fa-heart"></i> ${likeCount + 1}`;
            button.classList.add('liked');
            showAlert('点赞成功');
        }
    })
    .catch(error => {
        console.error('点赞失败：', error);
        button.innerHTML = originalContent;
        showAlert('操作失败，请稍后重试', 4000);
    })
    .finally(() => {
        button.disabled = false;
    });
}

// 为所有点赞和回复表单添加提交事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 为所有表单添加提交事件监听器
    const forms = document.querySelectorAll('form');
    forms.forEach(function(form) {
        form.addEventListener('submit', function(e) {
            // 保存滚动位置
            saveScrollPosition();
        });
    });
    
    // 页面加载完成后恢复滚动位置
    restoreScrollPosition();
    
    // 检查URL是否有post_id参数，如果有则定位到该帖子
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('post_id');
    if (postId) {
        scrollToPost(postId);
    }
});
</script>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        {% if search_query %}
                            <h4 class="mb-0">
                                <a href="{{ url_for('main.square') }}" class="text-white text-decoration-none">返回</a>
                            </h4>
                        {% else %}
                            <h4 class="mb-0">交流广场</h4>
                        {% endif %}
                        <form method="GET" action="{{ url_for('main.square') }}" class="d-flex">
                            <select name="search_type" class="form-select form-select-sm me-2" style="width: auto;">
                                <option value="content" {% if search_type == 'content' %}selected{% endif %}>搜索发言</option>
                                <option value="user" {% if search_type == 'user' %}selected{% endif %}>搜索用户发言</option>
                            </select>
                            <input type="text" name="search" class="form-control form-control-sm me-2" placeholder="搜索消息..." value="{{ search_query }}">
                            <button type="submit" class="btn btn-sm btn-light">搜索</button>
                        </form>
                    </div>
                </div>
                
                <!-- 聊天消息列表 -->
                <div class="card-body" style="max-height: 600px; overflow-y: auto; display: flex; flex-direction: column;">
                    {% if posts %}
                        {% for post in posts %}
                        <!-- 检查当前用户是否点赞了该帖子 -->
                        {% set liked = False %}
                        {% for like in post.likes.all() %}
                            {% if like.user_id == current_user.id %}
                                {% set liked = True %}
                            {% endif %}
                        {% endfor %}
                        
                        <!-- 自己发布的消息在右侧 -->
                        {% if post.user.id == current_user.id %}
                        <div id="post-{{ post.id }}" class="mb-4 d-flex justify-content-end">
                            <div class="flex-grow-1 max-w-xs ml-3">
                                <!-- 用户名和时间 -->
                                <div class="d-flex justify-content-end align-items-center mb-1">
                                    <small class="text-muted">{{ post.date_posted.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                    <strong class="ms-2 clickable-username" onclick="showUserInfo({{ post.user.id }})">{{ post.user.username }}</strong>
                                </div>
                                
                                <!-- 留言内容 - 淡黄色背景 -->
                                <div class="bg-warning bg-opacity-25 p-3 rounded">
                                    {% if '商品名称：' in post.content and '商品价格：' in post.content and '商品链接：' in post.content %}
                    {% set content_lines = (post.content | string()).split('\n') %}
                    {% set pre_content = [] %}
                    {% set item_title = '' %}
                    {% set item_price = '' %}
                    {% set item_link = '' %}
                    {% set item_seller = '' %}
                    {% set item_stock = '' %}
                    {% set item_views = '' %}
                    {% set item_follows = '' %}
                    {% set in_pre_content = true %}
                    {% set found_product_info = false %}
                    
                    <!-- 提取商品信息 -->
                    {% for line in content_lines %}
                        {% if line.startswith('商品名称：') %}
                            {% set item_title = line.replace('商品名称：', '') %}
                            {% set found_product_info = true %}
                            {% set in_pre_content = false %}
                        {% elif line.startswith('商品价格：') %}
                            {% set item_price = line.replace('商品价格：', '') %}
                        {% elif line.startswith('商品链接：') %}
                            {% set item_link = line.replace('商品链接：', '') %}
                        {% elif line.startswith('卖家：') %}
                            {% set item_seller = line.replace('卖家：', '') %}
                        {% elif line.startswith('库存：') %}
                            {% set item_stock = line.replace('库存：', '') %}
                        {% elif line.startswith('浏览：') %}
                            {% set item_views = line.replace('浏览：', '') %}
                        {% elif line.startswith('关注：') %}
                            {% set item_follows = line.replace('关注：', '') %}
                        {% elif in_pre_content and line.strip() %}
                            {% set _ = pre_content.append(line) %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 前置内容 -->
                    {% if pre_content | length > 0 %}
                        <p>{{ pre_content | join('\n') | e }}</p>
                    {% endif %}
                    
                    <!-- 商品信息 - 只显示文字信息 -->
                    <div class="ms-2 me-2 p-2 rounded" style="background-color: white;">
                        <h5 class="card-title">{{ item_title }}</h5>
                        <h6 class="card-subtitle mb-2 text-danger fw-bold">{{ item_price }}</h6>
                        <p class="card-text text-muted small">在售: {{ item_stock }}</p>
                        <p class="card-text text-muted small">卖家: {{ item_seller }}</p>
                        <p class="card-text text-muted small">浏览: {{ item_views }} | 关注: {{ item_follows }}</p>
                        <a href="{{ item_link }}" class="btn btn-outline-primary w-100">查看详情</a>
                    </div>
                {% else %}
                    <!-- 普通内容 -->
                    <p>{{ post.content | e }}</p>
                {% endif %}
                                    
                                    <!-- 图片（如果有） -->
                                    {% if post.image_file %}
                                    <div class="mt-2">
                                        <img src="{{ url_for('static', filename='uploads/' + post.image_file) }}" 
                                             alt="留言图片" 
                                             class="img-fluid rounded" 
                                             style="max-width: 300px;">
                                    </div>
                                    {% endif %}
                                </div>
                            
                            <!-- 操作按钮 -->
                            <div class="d-flex justify-content-end mt-1">
                                <!-- 回复按钮 -->
                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                        onclick="toggleReplyForm({{ post.id }}, {{ post.id }}, 'post', '{{ post.user.username }}')">
                                    回复
                                </button>
                                
                                <!-- @按钮 -->
                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                        onclick="mentionUser('{{ post.user.username }}')">
                                    @TA
                                </button>
                                
                                <!-- 点赞按钮 -->
                                <form method="POST" action="{{ url_for('main.like_post', post_id=post.id) }}" 
                                      style="display: inline;">
                                    {{ form.hidden_tag() }}
                                    <button type="submit" class="btn btn-sm btn-like {% if liked %}liked{% endif %}">
                                        <i class="fa {% if liked %}fa-heart{% else %}fa-heart-o{% endif %}"></i> {{ post.likes.count() }}
                                    </button>
                                </form>
                                
                                <!-- 删除按钮 -->
                                <form method="POST" action="{{ url_for('main.delete_post', post_id=post.id) }}" 
                                      style="display: inline;" id="delete-form-{{ post.id }}">
                                    {{ form.hidden_tag() }}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="if(confirm('确定要删除此帖子吗？')) { document.getElementById('delete-form-{{ post.id }}').submit(); }">
                                        删除
                                    </button>
                                </form>
                            </div>
                            
                            <!-- 回复表单 -->
                            <div id="reply-form-{{ post.id }}" class="mt-2 d-none">
                                <form method="POST" action="{{ url_for('main.reply_post', post_id=post.id) }}">
                                    {{ reply_forms[post.id].hidden_tag() }}
                                    <!-- 隐藏字段，存储被引用的帖子ID -->
                                    <input type="hidden" name="quoted_post_id" id="quoted-post-id-{{ post.id }}" value="">
                                    
                                    <!-- 引用信息显示区域 -->
                                    <div id="quote-info-{{ post.id }}" class="mb-2 d-none">
                                        <div class="bg-light p-2 rounded border border-primary">
                                            <p class="mb-0 fs-6 text-muted">
                                                <strong>回复:</strong> 点击发送即可回复
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        {{ reply_forms[post.id].content(class="form-control form-control-sm", placeholder="回复...") }}
                                        <button type="submit" class="btn btn-sm btn-primary">发送</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- 回复列表 -->
                            {% if post.replies.count() > 0 %}
                            <div class="mt-2">
                                <div id="replies-container-{{ post.id }}">
                                    {% for reply in post.replies.order_by(Reply.date_posted.asc()) %}
                                    <div class="reply-item d-flex justify-content-end mb-1 {% if loop.index > 1 and post.replies.count() > 3 %}reply-hidden{% endif %}" 
                                         id="reply-{{ reply.id }}">
                                        <div class="bg-light p-2 rounded" style="max-width: 80%;">
                                            <!-- 引用信息和时间在同一行 -->
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <!-- 引用信息 - 文本形式 -->
                                                {% if reply.quoted_reply %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong> 回复 @<strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.quoted_reply.user.id }})">{{ reply.quoted_reply.user.username }}</strong>:
                                                {% elif reply.quoted_post %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong> 回复 @<strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.quoted_post.user.id }})">{{ reply.quoted_post.user.username }}</strong>:
                                                {% else %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong>:
                                                {% endif %}
                                                
                                                <!-- 回复时间 -->
                                                <small class="text-muted">{{ reply.date_posted.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                            </div>
                                            
                                            <p class="mb-1 fs-6">{{ reply.content | e }}</p>
                                        
                                        <!-- 回复的操作按钮 -->
                                        <div class="d-flex justify-content-end mt-1">
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        onclick="toggleReplyForm({{ post.id }}, {{ reply.id }}, 'reply', '{{ reply.user.username }}')">
                                                    回复
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        onclick="mentionUser('{{ reply.user.username }}')">
                                                    @TA
                                                </button>
                                                <!-- 回复点赞按钮 -->
                                                {% set reply_liked = False %}
                                                {% for like in reply.likes.all() %}
                                                    {% if like.user_id == current_user.id %}
                                                        {% set reply_liked = True %}
                                                    {% endif %}
                                                {% endfor %}
                                                <form method="POST" action="{{ url_for('main.like_reply', reply_id=reply.id) }}" 
                                                      style="display: inline;">
                                                    {{ form.hidden_tag() }}
                                                    <button type="submit" class="btn btn-sm btn-like {% if reply_liked %}liked{% endif %}">
                                                    <i class="fa {% if reply_liked %}fa-heart{% else %}fa-heart-o{% endif %}"></i> {{ reply.likes.count() }}
                                                </button>
                                                </form>
                                                <!-- 删除按钮 -->
                                                {% if reply.user_id == current_user.id or current_user.is_admin %}
                                                <form method="POST" action="{{ url_for('main.delete_reply', reply_id=reply.id) }}" 
                                                      style="display: inline;" id="delete-reply-form-{{ reply.id }}">
                                                    {{ form.hidden_tag() }}
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="if(confirm('确定要删除此回复吗？')) { document.getElementById('delete-reply-form-{{ reply.id }}').submit(); }">
                                                        删除
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- 展开/收起按钮 -->
                                {% if post.replies.count() > 3 %}
                                <div class="text-center mt-1">
                                    <button class="btn btn-sm btn-link text-muted" 
                                            onclick="toggleReplies({{ post.id }}, {{ post.replies.count() }})" 
                                            id="toggle-btn-{{ post.id }}">
                                        展开更多回复 ({{ post.replies.count() - 1 }})
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        
                        <!-- 用户头像 -->
                        <img src="{{ url_for('static', filename='uploads/avatars/' + post.user.avatar) }}" 
                             alt="{{ post.user.username }}" 
                             class="rounded-circle clickable-avatar" 
                             style="width: 40px; height: 40px; object-fit: cover;" 
                             onclick="showUserInfo({{ post.user.id }})">
                    </div>
                    {% else %}
                    <!-- 他人发布的消息在左侧 -->
                    <div id="post-{{ post.id }}" class="mb-4 d-flex justify-content-start">
                        <!-- 用户头像 -->
                        <img src="{{ url_for('static', filename='uploads/avatars/' + post.user.avatar) }}" 
                             alt="{{ post.user.username }}" 
                             class="rounded-circle clickable-avatar" 
                             style="width: 40px; height: 40px; object-fit: cover; margin-right: 10px;" 
                             onclick="showUserInfo({{ post.user.id }})">
                        
                        <div class="flex-grow-1 max-w-xs">
                            <!-- 用户名和时间 -->
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <strong class="clickable-username" onclick="showUserInfo({{ post.user.id }})">{{ post.user.username }}</strong>
                                <small class="text-muted">{{ post.date_posted.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                            </div>
                            
                            <!-- 留言内容 - 淡灰色背景 -->
                            <div class="bg-light p-3 rounded">
                                {% if '商品名称：' in post.content and '商品价格：' in post.content and '商品链接：' in post.content %}
                    {% set content_lines = (post.content | string()).split('\n') %}
                    {% set pre_content = [] %}
                    {% set item_title = '' %}
                    {% set item_price = '' %}
                    {% set item_link = '' %}
                    {% set item_seller = '' %}
                    {% set item_stock = '' %}
                    {% set item_views = '' %}
                    {% set item_follows = '' %}
                    {% set in_pre_content = true %}
                    {% set found_product_info = false %}
                    
                    <!-- 提取商品信息 -->
                    {% for line in content_lines %}
                        {% if line.startswith('商品名称：') %}
                            {% set item_title = line.replace('商品名称：', '') %}
                            {% set found_product_info = true %}
                            {% set in_pre_content = false %}
                        {% elif line.startswith('商品价格：') %}
                            {% set item_price = line.replace('商品价格：', '') %}
                        {% elif line.startswith('商品链接：') %}
                            {% set item_link = line.replace('商品链接：', '') %}
                        {% elif line.startswith('卖家：') %}
                            {% set item_seller = line.replace('卖家：', '') %}
                        {% elif line.startswith('库存：') %}
                            {% set item_stock = line.replace('库存：', '') %}
                        {% elif line.startswith('浏览：') %}
                            {% set item_views = line.replace('浏览：', '') %}
                        {% elif line.startswith('关注：') %}
                            {% set item_follows = line.replace('关注：', '') %}
                        {% elif in_pre_content and line.strip() %}
                            {% set _ = pre_content.append(line) %}
                        {% endif %}
                    {% endfor %}
                    
                    <!-- 前置内容 -->
                    {% if pre_content | length > 0 %}
                        <p>{{ pre_content | join('\n') | safe }}</p>
                    {% endif %}
                    
                    <!-- 商品信息 - 只显示文字信息 -->
                    <div class="ms-2 me-2 p-2 rounded" style="background-color: white;">
                        <h5 class="card-title">{{ item_title }}</h5>
                        <h6 class="card-subtitle mb-2 text-danger fw-bold">{{ item_price }}</h6>
                        <p class="card-text text-muted small">在售: {{ item_stock }}</p>
                        <p class="card-text text-muted small">卖家: {{ item_seller }}</p>
                        <p class="card-text text-muted small">浏览: {{ item_views }} | 关注: {{ item_follows }}</p>
                        <a href="{{ item_link }}" class="btn btn-outline-primary w-100">查看详情</a>
                    </div>
                {% else %}
                    <!-- 普通内容 -->
                    <p>{{ post.content | safe }}</p>
                {% endif %}
                                
                                <!-- 图片（如果有） -->
                                {% if post.image_file %}
                                <div class="mt-2">
                                    <img src="{{ url_for('static', filename='uploads/' + post.image_file) }}" 
                                         alt="留言图片" 
                                         class="img-fluid rounded" 
                                         style="max-width: 300px;">
                                </div>
                                {% endif %}
                            </div>
                            
                            <!-- 操作按钮 -->
                            <div class="d-flex justify-content-start mt-1">
                                <!-- 回复按钮 -->
                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                        onclick="toggleReplyForm({{ post.id }}, {{ post.id }}, 'post', '{{ post.user.username }}')">
                                    回复
                                </button>
                                
                                <!-- @按钮 -->
                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                        onclick="mentionUser('{{ post.user.username }}')">
                                    @TA
                                </button>
                                
                                <!-- 点赞按钮 -->
                                <form method="POST" action="{{ url_for('main.like_post', post_id=post.id) }}" 
                                      style="display: inline;">
                                    {{ form.hidden_tag() }}  
                                    <button type="submit" class="btn btn-sm btn-like {% if liked %}liked{% endif %}"> 
                                        <i class="fa {% if liked %}fa-heart{% else %}fa-heart-o{% endif %}"></i> {{ post.likes.count() }}
                                    </button>
                                </form>
                                
                                <!-- 删除按钮 -->
                                {% if current_user.is_admin %}
                                <form method="POST" action="{{ url_for('main.delete_post', post_id=post.id) }}" 
                                      style="display: inline;" id="delete-form-{{ post.id }}">
                                    {{ form.hidden_tag() }}
                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                            onclick="if(confirm('确定要删除此帖子吗？')) { document.getElementById('delete-form-{{ post.id }}').submit(); }">
                                        删除
                                    </button>
                                </form>
                                {% endif %}
                            </div>
                            
                            <!-- 回复表单 -->
                            <div id="reply-form-{{ post.id }}" class="mt-2 d-none">
                                <form method="POST" action="{{ url_for('main.reply_post', post_id=post.id) }}">
                                    {{ reply_forms[post.id].hidden_tag() }}
                                    <!-- 隐藏字段，存储被引用的帖子ID -->
                                    <input type="hidden" name="quoted_post_id" id="quoted-post-id-{{ post.id }}" value="">
                                    
                                    <!-- 引用信息显示区域 -->
                                    <div id="quote-info-{{ post.id }}" class="mb-2 d-none">
                                        <div class="bg-light p-2 rounded border border-primary">
                                            <p class="mb-0 fs-6 text-muted">
                                                <strong>回复:</strong> 点击发送即可回复
                                            </p>
                                        </div>
                                    </div>
                                    
                                    <div class="input-group">
                                        {{ reply_forms[post.id].content(class="form-control form-control-sm", placeholder="回复...") }}
                                        <button type="submit" class="btn btn-sm btn-primary">发送</button>
                                    </div>
                                </form>
                            </div>
                            
                            <!-- 回复列表 -->
                            {% if post.replies.count() > 0 %}
                            <div class="mt-2">
                                <div id="replies-container-{{ post.id }}">
                                    {% for reply in post.replies.order_by(Reply.date_posted.asc()) %}
                                    <div class="reply-item d-flex justify-content-start mb-1 {% if loop.index > 1 and post.replies.count() > 3 %}reply-hidden{% endif %}" 
                                         id="reply-{{ reply.id }}">
                                        <div class="bg-light p-2 rounded" style="max-width: 80%;">
                                            <!-- 引用信息和时间在同一行 -->
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <!-- 引用信息 - 文本形式 -->
                                                {% if reply.quoted_reply %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong> 回复 @<strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.quoted_reply.user.id }})">{{ reply.quoted_reply.user.username }}</strong>:
                                                {% elif reply.quoted_post %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong> 回复 @<strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.quoted_post.user.id }})">{{ reply.quoted_post.user.username }}</strong>:
                                                {% else %}
                                                <strong class="fs-7 text-muted clickable-username" onclick="showUserInfo({{ reply.user.id }})">{{ reply.user.username }}</strong>:
                                                {% endif %}
                                                
                                                <!-- 回复时间 -->
                                                <small class="text-muted">{{ reply.date_posted.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                            </div>
                                            
                                            <p class="mb-1 fs-6">{{ reply.content | safe }}</p>
                                            
                                            <!-- 回复的操作按钮 -->
                                            <div class="d-flex justify-content-start mt-1">
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        onclick="toggleReplyForm({{ post.id }}, {{ reply.id }}, 'reply', '{{ reply.user.username }}')">
                                                    回复
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary me-1" 
                                                        onclick="mentionUser('{{ reply.user.username }}')">
                                                    @TA
                                                </button>
                                                <!-- 回复点赞按钮 -->
                                                {% set reply_liked = False %}
                                                {% for like in reply.likes.all() %}
                                                    {% if like.user_id == current_user.id %}
                                                        {% set reply_liked = True %}
                                                    {% endif %}
                                                {% endfor %}
                                                <form method="POST" action="{{ url_for('main.like_reply', reply_id=reply.id) }}" 
                                                      style="display: inline;">
                                                    {{ form.hidden_tag() }}
                                                    <button type="submit" class="btn btn-sm btn-like {% if reply_liked %}liked{% endif %}">
                                                    <i class="fa {% if reply_liked %}fa-heart{% else %}fa-heart-o{% endif %}"></i> {{ reply.likes.count() }}
                                                </button>
                                                </form>
                                                <!-- 删除按钮 -->
                                                {% if reply.user_id == current_user.id %}
                                                <form method="POST" action="{{ url_for('main.delete_reply', reply_id=reply.id) }}" 
                                                      style="display: inline;" id="delete-reply-form-{{ reply.id }}">
                                                    {{ form.hidden_tag() }}
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            onclick="if(confirm('确定要删除此回复吗？')) { document.getElementById('delete-reply-form-{{ reply.id }}').submit(); }">
                                                        删除
                                                    </button>
                                                </form>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                
                                <!-- 展开/收起按钮 -->
                                {% if post.replies.count() > 3 %}
                                <div class="text-center mt-1">
                                    <button class="btn btn-sm btn-link text-muted" 
                                            onclick="toggleReplies({{ post.id }}, {{ post.replies.count() }})" 
                                            id="toggle-btn-{{ post.id }}">
                                        展开更多回复 ({{ post.replies.count() - 1 }})
                                    </button>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">没有相关发言！</p>
                    </div>
                {% endif %}
                </div>
                
                <!-- 消息输入区域 -->
                <div class="card-footer">
                    <form method="POST" action="" enctype="multipart/form-data">
                        {{ form.hidden_tag() }}
                        
                        <!-- 留言内容 -->
                        <div class="mb-3">
                            {% if form.content.errors %}
                                {{ form.content(class="form-control is-invalid", rows=3, placeholder="请输入留言内容...") }}
                                <div class="invalid-feedback">
                                    {% for error in form.content.errors %}
                                        <span>{{ error }}</span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                {{ form.content(class="form-control", rows=3, placeholder="请输入留言内容...") }}
                            {% endif %}
                        </div>
                        
                        <!-- 图片上传和发布按钮 -->
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="flex-grow-1 me-2">
                                <div class="input-group">
                                    <label class="input-group-text" for="{{ form.picture.id }}">上传图片</label>
                                    {{ form.picture(class="form-control") }}
                                </div>
                                {% if form.picture.errors %}
                                    {% for error in form.picture.errors %}
                                        <small class="text-danger d-block mt-1">{{ error }}</small>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}